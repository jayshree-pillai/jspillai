Feature: Centralized retry policy for transient LLM failures
This covers one retry policy definition, allowlisted retryable errors, structured failure output, telemetry, and non-retryable error handling.

Scenario: Retry policy is defined centrally and applied to all sections
Given a centralized retry policy is configured with max_attempts and backoff
And section_id "company_overview" is registered
And section_id "key_risks" is registered
When I run "company_overview" and then run "key_risks"
Then both runs use the same configured retry policy
And the retry behavior is consistent across sections

Scenario: Retry occurs only for allowlisted retryable error types/codes
Given the retry policy defines retryable error code "RATE_LIMIT"
And the LLM call for section_id "company_overview" returns "RATE_LIMIT" on the first attempt
When I run section_id "company_overview"
Then the LLM client retries according to max_attempts and backoff
And the subsequent attempt is made

Scenario: Non-retryable errors do not trigger retries
Given the retry policy has an explicit allowlist of retryable errors
And the LLM call returns a non-retryable error "BAD_REQUEST"
When I run a section
Then the LLM client does not retry
And the run fails immediately with outcome "FAILED"

Scenario: Schema validation failure does not trigger retries
Given a section run produces output that fails schema validation
When I run that section
Then the system marks the section as failed due to "SCHEMA_VALIDATION_FAILED"
And no LLM retry is attempted due to schema failure

Scenario: Guardrail/policy failure does not trigger retries
Given a section run produces output that violates guardrails/policy
When I run that section
Then the system marks the section as failed due to "POLICY_VIOLATION"
And no LLM retry is attempted due to guardrail failure

Scenario: Exhausting retries returns structured failure details
Given the retry policy is configured with max_attempts 3
And each LLM attempt fails with a retryable error "TIMEOUT"
When I run section_id "company_overview"
Then the system returns a structured failure including attempts=3 and last_error="TIMEOUT"
And the failure includes section_id "company_overview" and the resolved model_id

Scenario: Telemetry records retry count and final outcome
Given the retry policy is configured
And the first LLM attempt fails with a retryable error
And a subsequent retry succeeds
When I run a section
Then telemetry records the retry_count greater than 0
And telemetry records the final outcome "SUCCEEDED"
